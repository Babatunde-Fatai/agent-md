# agent-md Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build a production-ready `agent-md` CLI that generates static agent-friendly Markdown files and a manifest from sitemap or URL input.

**Architecture:** Build a modular TypeScript CLI app with dedicated pipeline modules for URL ingestion, rendering (Playwright/static), content extraction (Readability), HTML-to-Markdown conversion (Turndown + GFM), and deterministic file/manifest writing. Keep path-mapping and metadata generation in pure utility functions for robust testability.

**Tech Stack:** TypeScript, Node.js, Commander, Playwright, JSDOM, @mozilla/readability, Turndown, turndown-plugin-gfm, fast-xml-parser, Vitest.

---

### Task 1: Project bootstrap and CLI shell

**Files:**
- Create: `package.json`, `tsconfig.json`, `vitest.config.ts`
- Create: `src/cli/index.ts`, `src/index.ts`

1. Initialize npm package and TypeScript build/test scripts.
2. Implement `agent-md build` CLI with required flags and validation.
3. Wire CLI to core `buildAgentMarkdown` function.
4. Verify typecheck/build commands run.

### Task 2: URL ingestion (sitemap + file)

**Files:**
- Create: `src/core/inputs.ts`, `src/core/types.ts`

1. Add sitemap parser for `<loc>` and optional `<lastmod>` entries.
2. Add URL file parser (`urls.txt`, line-based, comments/blank lines ignored).
3. Normalize, de-duplicate, and sort URLs for deterministic output.
4. Apply `--max-pages` truncation.

### Task 3: Rendering layer (playwright/static)

**Files:**
- Create: `src/core/renderer.ts`

1. Implement `playwright` renderer with concurrency control.
2. Implement `static` renderer via fetch.
3. Ensure Playwright waits for `domcontentloaded` plus optional extra delay.
4. Return rendered HTML/title/final URL/base origin.

### Task 4: Extraction + conversion

**Files:**
- Create: `src/extract/readability.ts`, `src/convert/markdown.ts`

1. Parse HTML via JSDOM, absolutize links/images before conversion.
2. Use Readability for main content extraction; fallback to `<body>`.
3. Convert extracted HTML to Markdown via Turndown + GFM plugin.
4. Preserve headings/code blocks/link targets/image references.

### Task 5: Output + manifest

**Files:**
- Create: `src/core/pathing.ts`, `src/core/build.ts`, `src/core/fs.ts`

1. Implement URL-to-output path mapping rules with `index.md` behavior.
2. Add frontmatter generation (title, source, hash, etc.).
3. Add lastmod skip optimization based on output mtime.
4. Write files deterministically and emit `/agent/index.json` manifest.

### Task 6: TDD tests for path mapping

**Files:**
- Create: `tests/pathing.test.ts`

1. Write failing tests for URL/path mapping (query stripping, slashes, root).
2. Run tests and verify fail.
3. Implement minimal path mapping until tests pass.
4. Run full test suite.

### Task 7: CI workflow + docs

**Files:**
- Create: `.github/workflows/generate-agent-markdown.yml`, `USAGE.md`
- Modify: `README.md`

1. Add copy-paste-ready GitHub Action.
2. Write `USAGE.md` with framework recipes and limitations.
3. Update README quickstart and key commands.

### Task 8: Verification and session updates

**Files:**
- Modify: `.claude/sessions/2026-02-13-SESSION.md`, `.claude/MEMORY.md`

1. Run typecheck, tests, and build.
2. Perform critical self-review and record residual risks.
3. Update session + memory decisions.
